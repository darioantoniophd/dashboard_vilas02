---
title: "Plot curvas un dataset"
output: html_notebook
---

```{r}
# import measurement table

# load data in 'global' chunk so it can be shared
# by all users of the dashboard

# Load the googlesheets4 package
library(googlesheets4)

# Authenticate with Google Sheets (you may be prompted to sign in)
gs4_auth(email=TRUE)

options(date.format = "%d/%m/%y", stringsAsFactors = FALSE)

# Cargar la tabla VL2-R-01-Registro de mediciones
# Get the sheet ID and sheet name
sheet_id <- "1k10kj7jHHr8vDWXKHHN4v6UCd2gn5u5cq2a9960cfTo"
sheet_name <- "01_Registro"
# Set the range to read, starting from the fourth row
range <- paste0(sheet_name, "!A4:AI")
# Read the sheet data into R as a data frame, using the fourth row as the column names
my_data <- read_sheet(sheet_id, sheet_name, range, col_names = TRUE)
# convert columns  to numeric
my_data$Fecha <- as.Date(my_data$Fecha)
my_data$Pmed_base = as.numeric(as.character(my_data$Pmed_base))
my_data$Pmed_A10 = as.numeric(as.character(my_data$Pmed_A10))
my_data$`A10 (600s+CT) [Pa]` = as.numeric(as.character(my_data$`A10 (600s+CT) [Pa]`))
my_data$`A10R` = 100/(1+1400/my_data$`A10 (600s+CT) [Pa]`)
my_data$`A1 (60s+CT) [Pa]` = as.numeric(as.character(my_data$`A1 (60s+CT) [Pa]`))
my_data$`A5 (300s+CT) [Pa]` = as.numeric(as.character(my_data$`A5 (300s+CT) [Pa]`))
my_data$`A20 (1200s+CT) [Pa]` = as.numeric(as.character(my_data$`A20 (1200s+CT) [Pa]`))
my_data$`CT [seg]` = as.numeric(as.character(my_data$`CT [seg]`))
my_data$Alpha <- as.numeric(as.character(my_data$Alpha))
my_data$`Nro Cartucho` <- as.character(my_data$`Nro Cartucho`)
my_data$`MCF ??` = as.numeric(as.character(my_data$`MCF ??`))
my_data$`Presion de desprendimiento [Pa]` = as.numeric(as.character(my_data$`Presion de desprendimiento [Pa]`))
my_data$`CT [seg]` = as.numeric(as.character(my_data$`CT [seg]`))
my_data$Frecuencia_Hz = as.numeric(as.character(my_data$Frecuencia_Hz))
my_data$`Canal abierto Promedio QC2 [Pa]` = as.numeric(as.character(my_data$`Canal abierto Promedio QC2 [Pa]`))
#my_data$Medicion <- paste(my_data$Prueba,my_data$Medicion) 
my_data$`Canal cerrado Promedio QC1 [Pa]` = as.numeric(as.character(my_data$`Canal cerrado Promedio QC1 [Pa]`))
my_data$`Forma curva amplitud cruda` <- as.character(my_data$`Forma curva amplitud cruda`)
# Create new column deltaPmed 
my_data$deltaPmed <- my_data$Pmed_A10 - my_data$Pmed_base
#eliminamos las observaciones que NO se deben considerar en el anÃ¡lisis y sin datos en A10
subset_data <- subset(my_data, `Problema`=="ninguno")
subset_data <- subset_data[!is.na(subset_data$`A10 (600s+CT) [Pa]`), ]


# parse data files

# set the directory path
dir_path <- "/home/dario/Documents/mediciones_vilas02/data"

file_extension <- ".dat"

# Find all files with the specified extension recursively in the directory
all_files <- list.files(path = dir_path, recursive = TRUE, pattern = file_extension, full.names = TRUE)

#file_list_nopath <- basename(file_list)

# Append ".dat" to file_name column
subset_data$MedicionArchivo <- paste(subset_data$Medicion, ".dat", sep = "")

# Filter files to be loaded based on file_names_list
files_to_load <- all_files[basename(all_files) %in% subset_data$MedicionArchivo]

# Load files into separate datasets named as the files
# Create an empty dataset
amplitudes_base <- data.frame()

for (file in files_to_load) {
  # Extract file name without extension
  file_name <- gsub("\\..*$", "", basename(file))
  # Load file into a dataset 
  medicion <- read.csv(file,sep = " ", header = TRUE)
  
  medicion$acu.t = as.numeric(as.character(medicion$acu.t))
  medicion$acu.t <- medicion$acu.t/1000
  medicion$acu.A1 = as.numeric(as.character(medicion$acu.A1))
  
  if (grepl("SA", file_name) && grepl("VI", file_name)) {
  # Filter the dataset based on the condition
  filtered_data <- medicion[medicion$acu.t >= 60 & medicion$acu.t <= 100, ]
  }
  if (grepl("SA", file_name) && grepl("VE", file_name)) {
  # Filter the dataset based on the condition
  filtered_data <- medicion[medicion$acu.t >= 45 & medicion$acu.t <= 55, ]
  }
 if (grepl("PS", file_name) && grepl("VI", file_name)) {
  # Filter the dataset based on the condition
  filtered_data <- medicion[medicion$acu.t >= 45 & medicion$acu.t <= 150, ]
  }
  if (grepl("PS", file_name) && grepl("VE", file_name)) {
  # Filter the dataset based on the condition
  filtered_data <- medicion[medicion$acu.t >= 45 & medicion$acu.t <= 55, ]
  }
   if (grepl("RN", file_name) && grepl("VI", file_name)) {
  # Filter the dataset based on the condition
  filtered_data <- medicion[medicion$acu.t >= 60 & medicion$acu.t <= 100, ]
  }
  if (grepl("RN", file_name) && grepl("VE", file_name)) {
  # Filter the dataset based on the condition
  filtered_data <- medicion[medicion$acu.t >= 45 & medicion$acu.t <= 55, ]
  }
   if (grepl("RP", file_name) && grepl("VI", file_name)) {
  # Filter the dataset based on the condition
  filtered_data <- medicion[medicion$acu.t >= 100 & medicion$acu.t <= 200, ]
  }
  if (grepl("RP", file_name) && grepl("VE", file_name)) {
  # Filter the dataset based on the condition
  filtered_data <- medicion[medicion$acu.t >= 45 & medicion$acu.t <= 55, ]
  }
  
  
  
  
  # Calculate the average of the filtered rows
  average_amplitud <- mean(filtered_data$acu.A1)
  # Create the new row to append
  new_row <- data.frame(Medicion = file_name, amplitud_base = average_amplitud)
  # Append the new row to the dataset
  amplitudes_base <- rbind(amplitudes_base, new_row)
}

# Merge data1 and data2 based on the "medicion" column
merged_data <- merge(subset_data, amplitudes_base, by = "Medicion", all.x = TRUE)

# Rename the "amp_base" column in the merged data
colnames(merged_data)[ncol(merged_data)] <- "amp_base"

# Assign the merged data to data1 with the additional "amp_base" column
subset_data <- merged_data

# Save updated_dataset as a CSV file
write.csv(subset_data, "subset_data.csv", row.names = FALSE)

```
