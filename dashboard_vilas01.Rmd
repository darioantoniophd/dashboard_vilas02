---
title: "Dashboard Vilas 01"
output: flexdashboard::flex_dashboard
orientation: columns
vertical_layout: fill
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(dplyr)
library(ggplot2)

```

```{r global, include=FALSE}
# load data in 'global' chunk so it can be shared
# by all users of the dashboard
load(file = "subset_data_vilas01.Rdata")
load(file = "my_data_vilas01.Rdata")

# Function that filters dataset midata where column Muestra takes values in values_muestra. Then plots specified column "a_col" versus specified column "x_col" of specified dataset "midata" using column "color_col" for color

my_plot <- function(midata, x_col, a_col, color_col, shape_col, plot_type) {
 
 if (plot_type == "scatter_A_vs_Prueba") {
   # Create scatter plot using ggplot2
  ggplot(midata, aes(x = Prueba, y = .data[[a_col]], color = .data[[color_col]], shape = .data[[shape_col]])) +
    geom_point(size= 3) +
    labs(title = paste0(a_col, " vs. ", x_col), x = x_col, y = a_col, color = color_col, shape=shape_col)+
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
 
} else if (plot_type == "boxplot_por_prueba"){
  # boxplot with labels
  # calculate CV values for each group
  cv_data <- midata %>%
  group_by(Prueba) %>%
  summarise(cv = round(100*sd(.data[[a_col]])/mean(.data[[a_col]]), 0))
  #para calcular el N de cada grupo/prueba
  N_data <- midata %>%
  count(Prueba, name = "N")
  # plot boxplot with CV and N labels
  ggplot(midata, aes(x = Prueba, y = .data[[a_col]], color = .data[[color_col]])) +
  geom_boxplot() +
  labs(title = paste0(a_col, " vs. ", x_col), x = x_col, y = a_col, color = color_col, shape=shape_col)+
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  geom_text(data = N_data, aes(x = Prueba, y = min(midata[[a_col]]), label = paste0("", N)), vjust = -1, size = 3, color = "red") +
  geom_text(data = cv_data, aes(x = Prueba, y = min(midata[[a_col]]), label = paste0("", cv, "%")), vjust = 1, angle =55, size = 3, color = "blue", nudge_x = -0.2)
  
} else if (plot_type == "sigma_A_por_prueba"){
  # boxplot with labels
  # calculate CV values for each group
  cv_data <- midata %>%
  group_by(Prueba) %>%
  summarise(promedio=mean(.data[[a_col]]),sigma = sd(.data[[a_col]]),muestra=max(Muestra),activacion=max(Activacion))
  
  #para calcular el N de cada grupo/prueba
  N_data <- midata %>%
  count(Prueba, name = "N")
  # plot boxplot with CV and N labels
  
circularise <- function(d, n=30){
  angle <- seq(-pi, pi, length = n)
  make_circle <- function(x,y,r,id, circle_color){
    data.frame(x=x+r*cos(angle), y=y+r*sin(angle), id, circle_color)
  }
  lmat <- mapply(make_circle, id = seq_len(nrow(d)), 
                x = 0, y=d[["promedio"]], r=d[["sigma"]],circle_color=d[["muestra"]], SIMPLIFY = FALSE)
  do.call(rbind, lmat)
}

circles <- circularise(cv_data)

p <- ggplot() + 
  geom_point(data=cv_data, aes(x=0, y=promedio))

p + geom_polygon(aes(x, y, group=id, fill=circle_color), data=circles) +
    coord_fixed()

}
  else if (plot_type == "boxplot_por_muestra"){
  
  #Variación inter-día para cada muestra
# calculate CV values for each group
cv_muestra <- midata %>%
  group_by(Muestra) %>%
  summarise(cv = round(100*sd(.data[[a_col]])/mean(.data[[a_col]]), 0))

#para calcular el N de caja grupo/prueba
library(dplyr)

N_muestra <- midata %>%
  count(Muestra, name = "N")

#box plot con CV y N
ggplot(midata, aes(x = Muestra, y = .data[[a_col]])) +
  geom_boxplot() +
  labs(title = paste0(a_col, " vs. ", "Muestra"), x = "Muestra", y = a_col)+
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.7)) +
  geom_text(data = N_muestra, aes(x = N_muestra$Muestra, y = max(midata[[a_col]]), label = paste0("", N)), vjust = 0, size = 3, color = "red") +
  geom_text(data = cv_muestra, aes(x = Muestra, y = max(midata[[a_col]]), label = paste0("", cv, "%")), vjust = 0, angle =0, size = 3, color = "blue", nudge_x = 0.25)

  
  }
  
 
}
  
 

```

# Plots

Column {.sidebar}
--------------------------------------------------

```{r}
selectInput("values_muestra", "Select values for Muestra:", choices = unique(subset_data_vilas01$Muestra), multiple = TRUE, selected = unique(subset_data_vilas01$Muestra))
selectInput("values_activacion", "Select values for Activacion:", choices = unique(subset_data_vilas01$Activacion), multiple = TRUE, selected = unique(subset_data_vilas01$Activacion))
selectInput("values_capilar", "Select values for Capilar:", choices = unique(subset_data_vilas01$Capilar), multiple = TRUE, selected = unique(subset_data_vilas01$Capilar))
selectInput("value_amplitud", "Select Amplitude:", choices = c('A10 (600s+CT) [Pa]'), multiple = FALSE, selected ='A10 (600s+CT) [Pa]')
selectInput("plot_type", "Select plot type:", choices = c('scatter_A_vs_Prueba','boxplot_por_prueba','boxplot_por_muestra'), multiple = FALSE,selected ='scatter')

# Date range input widgets
dateRangeInput("date_range", "Select date range:", 
                 start = as.Date("2021-07-01"), end = Sys.Date(), 
                 format = "yyyy-mm-dd", separator = " to ")


```

Column {data-width=650}
-----------------------------------------------------------------------

### Chart A

```{r}



 # Create reactive subset data
# Este es el subset que se usa para hacer estadística de mediciones con Problemas
  reactive_my_data_vilas01 <- reactive({
    subset(my_data_vilas01, 
           Muestra %in% input$values_muestra & 
           Activacion %in% input$values_activacion & 
           Fecha >= input$date_range[1] & Fecha <= input$date_range[2] &
           Capilar %in% input$values_capilar)
  })

# Este es el subset de las mediciones sin problemas que se usan para todos los plots del panel principal
reactive_subset_data_vilas01 <- reactive({
  subset(subset_data_vilas01, 
           Muestra %in% input$values_muestra & 
           Activacion %in% input$values_activacion & 
           Fecha >= input$date_range[1] & Fecha <= input$date_range[2] &
           Capilar %in% input$values_capilar
          )
  
  })



  # Render scatter plot based on filtered data object and user's selected x, a, and color columns
  renderPlot({
    my_plot(midata = reactive_subset_data_vilas01(), x_col = "Prueba", a_col = input$value_amplitud, color_col = "Muestra",  shape_col = "Activacion",plot_type=input$plot_type)
  })



```

Column {data-width=350}
-----------------------------------------------------------------------

### Chart B

```{r}
renderPlot({


# Create a data frame with the count of each value in the "Problema" column
problema_count <- data.frame(table(reactive_my_data_vilas01()$Problema))

# Add a column to indicate whether the value is "ninguno" or not
problema_count$is_ninguno <- ifelse(problema_count$Var1 == "ninguno", "ninguno", "otro")

# Summarize the counts by "ninguno" and "otro"
problema_summary <- aggregate(Freq ~ is_ninguno, data = problema_count, sum)

# Plot the summary using a stacked bar plot
ggplot(problema_summary, aes(x = "", y = Freq, fill = is_ninguno)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  xlab("") +
  ylab("Count") +
  ggtitle("Count of rows with 'ninguno' vs other values in 'Problema' column") +
  geom_text(aes(label = paste0(round(Freq / sum(Freq) * 100), "%")), 
            position = position_stack(vjust = 0.5))
})  
  
```

### Chart C

```{r}
library(RColorBrewer)

renderPlot({
# Create a data frame with the count of each value in the "Problema" column
problema_count <- data.frame(table(reactive_my_data_vilas01()$Problema))

# Remove the rows with "ninguno"
problema_count <- problema_count[problema_count$Var1 != "ninguno", ]

# Set the fill colors using the Paired color palette
fill_colors <- brewer.pal(nrow(problema_count), "Paired")

# Plot the counts of rows by value using a stacked bar plot with contrasting colors
ggplot(problema_count, aes(x = "", y = Freq, fill = Var1)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  xlab("") +
  ylab("Count") +
  ggtitle("Count of rows with values other than 'ninguno' in 'Problema' column, grouped by value") +
  scale_fill_manual(values = fill_colors) +
  geom_text(aes(label = paste0(round(Freq / sum(Freq) * 100), "%")), 
            position = position_stack(vjust = 0.5))
})  
```

# Conclusiones

### Problemas principales
* 
*

### Observaciones más relevantes
* Hay pocas mediciones con Rotrol En Capi CH.PMMA se distingue N de P. En Aguja 18g y Capi GR. PMMA se solapan N y P. El n es muy chico.
* Las mediciones de Sangre y Rotrol con capi CH. tienen mejor repetibilidad que en el Vilas 02.

### Observaciones secundarias
* 
